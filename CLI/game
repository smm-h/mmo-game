#!/bin/bash
# MMO Game CLI Tool - Unified development commands
# Usage: ./CLI/game <command> [options]

set -e

# ============================================================================
# CONFIGURATION - Edit these variables as needed
# ============================================================================
GAME_PORT="${GAME_PORT:-7777}"
HTTP_PORT="${HTTP_PORT:-5000}"
SERVER_PROJECT="src/Game.Server/Game.Server.csproj"
CLIENT_PROJECT="src/Game.Client.DesktopGL/Game.Client.DesktopGL.csproj"
LOG_DIR="${LOG_DIR:-/tmp/mmo-game}"
NETWORK_CONFIG="network.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# HELPERS
# ============================================================================
info()  { echo -e "${BLUE}[INFO]${NC} $1"; }
ok()    { echo -e "${GREEN}[OK]${NC} $1"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
err()   { echo -e "${RED}[ERROR]${NC} $1"; }

ensure_log_dir() {
    mkdir -p "$LOG_DIR"
}

cd_root() {
    cd "$(dirname "$0")/.."
}

# ============================================================================
# COMMANDS
# ============================================================================

cmd_help() {
    cat << 'EOF'
MMO Game CLI - Development Commands

USAGE: ./CLI/game <command> [options]

COMMANDS:
  server      Start the game server
  client      Start the game client
  stop        Stop server/client processes
  restart     Stop then start server
  build       Build projects
  logs        View/analyze logs
  status      Show running processes and ports
  clean       Clean build artifacts and logs

SERVER:
  game server [--bg]      Start server (--bg for background)
  game server --follow    Start and tail logs

CLIENT:
  game client             Start client (foreground)
  game client --bg        Start client in background

STOP:
  game stop               Stop all game processes
  game stop server        Stop only server
  game stop client        Stop only client
  game stop --ports       Kill processes on game ports

BUILD:
  game build              Build all projects
  game build server       Build server only
  game build client       Build client only
  game build --release    Build release versions

LOGS:
  game logs               Show recent server log
  game logs client        Show recent client log
  game logs --errors      Show only errors from logs
  game logs --summary     Summarize log (connections, zones, errors)
  game logs --tail        Tail server log in real-time
  game logs --clean       Remove all log files

STATUS:
  game status             Show running processes and port usage

ENVIRONMENT VARIABLES:
  GAME_PORT    Game server port (default: 7777)
  HTTP_PORT    HTTP API port (default: 5000)
  LOG_DIR      Log directory (default: /tmp/mmo-game)

EXAMPLES:
  game server --bg && game client    # Start server bg, then client
  game restart && game client        # Restart server and start client
  game logs --summary                # Quick log analysis
  game stop --ports                  # Force free ports
EOF
}

cmd_server() {
    cd_root
    ensure_log_dir

    local bg=false
    local follow=false

    for arg in "$@"; do
        case $arg in
            --bg) bg=true ;;
            --follow) follow=true ;;
        esac
    done

    if $bg; then
        info "Starting server in background on port $GAME_PORT..."
        nohup dotnet run --project "$SERVER_PROJECT" > "$LOG_DIR/server.log" 2>&1 &
        local pid=$!
        echo $pid > "$LOG_DIR/server.pid"
        sleep 2
        if ps -p $pid > /dev/null 2>&1; then
            ok "Server started (PID: $pid)"
            info "Logs: $LOG_DIR/server.log"
        else
            err "Server failed to start. Check: game logs"
            exit 1
        fi
    elif $follow; then
        info "Starting server with log tailing..."
        dotnet run --project "$SERVER_PROJECT" 2>&1 | tee "$LOG_DIR/server.log"
    else
        info "Starting server on port $GAME_PORT..."
        dotnet run --project "$SERVER_PROJECT" 2>&1 | tee "$LOG_DIR/server.log"
    fi
}

cmd_client() {
    cd_root
    ensure_log_dir

    local bg=false
    for arg in "$@"; do
        case $arg in
            --bg) bg=true ;;
        esac
    done

    if $bg; then
        info "Starting client in background..."
        nohup dotnet run --project "$CLIENT_PROJECT" > "$LOG_DIR/client.log" 2>&1 &
        local pid=$!
        echo $pid > "$LOG_DIR/client.pid"
        sleep 2
        ok "Client started (PID: $pid)"
        info "Logs: $LOG_DIR/client.log"
    else
        info "Starting client..."
        dotnet run --project "$CLIENT_PROJECT" 2>&1 | tee "$LOG_DIR/client.log"
    fi
}

cmd_stop() {
    cd_root
    ensure_log_dir

    local target="${1:-all}"

    case $target in
        server)
            info "Stopping server..."
            if [ -f "$LOG_DIR/server.pid" ]; then
                kill $(cat "$LOG_DIR/server.pid") 2>/dev/null && ok "Server stopped" || warn "Server not running"
                rm -f "$LOG_DIR/server.pid"
            fi
            pkill -f "$SERVER_PROJECT" 2>/dev/null || true
            ;;
        client)
            info "Stopping client..."
            if [ -f "$LOG_DIR/client.pid" ]; then
                kill $(cat "$LOG_DIR/client.pid") 2>/dev/null && ok "Client stopped" || warn "Client not running"
                rm -f "$LOG_DIR/client.pid"
            fi
            pkill -f "$CLIENT_PROJECT" 2>/dev/null || true
            ;;
        --ports)
            info "Killing processes on ports $GAME_PORT and $HTTP_PORT..."
            fuser -k "$GAME_PORT/udp" 2>/dev/null && ok "Freed UDP port $GAME_PORT" || info "UDP port $GAME_PORT was free"
            fuser -k "$GAME_PORT/tcp" 2>/dev/null && ok "Freed TCP port $GAME_PORT" || info "TCP port $GAME_PORT was free"
            fuser -k "$HTTP_PORT/tcp" 2>/dev/null && ok "Freed TCP port $HTTP_PORT" || info "TCP port $HTTP_PORT was free"
            ;;
        all|*)
            cmd_stop server
            cmd_stop client
            ;;
    esac
}

cmd_restart() {
    cmd_stop "$@"
    sleep 1
    cmd_server --bg
}

cmd_build() {
    cd_root

    local target="${1:-all}"
    local config="Debug"

    for arg in "$@"; do
        case $arg in
            --release) config="Release" ;;
        esac
    done

    case $target in
        server)
            info "Building server ($config)..."
            dotnet build "$SERVER_PROJECT" -c "$config"
            ok "Server built"
            ;;
        client)
            info "Building client ($config)..."
            dotnet build "$CLIENT_PROJECT" -c "$config"
            ok "Client built"
            ;;
        all|--release)
            info "Building all projects ($config)..."
            dotnet build -c "$config"
            ok "All projects built"
            ;;
    esac
}

cmd_logs() {
    cd_root
    ensure_log_dir

    local target="server"
    local mode="show"
    local lines=50

    for arg in "$@"; do
        case $arg in
            client) target="client" ;;
            server) target="server" ;;
            --errors) mode="errors" ;;
            --summary) mode="summary" ;;
            --tail) mode="tail" ;;
            --clean) mode="clean" ;;
            --all) lines=9999 ;;
        esac
    done

    local logfile="$LOG_DIR/$target.log"

    case $mode in
        show)
            if [ -f "$logfile" ]; then
                info "Last $lines lines of $target log:"
                tail -n "$lines" "$logfile"
            else
                warn "No log file found: $logfile"
            fi
            ;;
        errors)
            if [ -f "$logfile" ]; then
                info "Errors in $target log:"
                grep -iE "(error|fail|exception|critical)" "$logfile" || info "No errors found"
            else
                warn "No log file found: $logfile"
            fi
            ;;
        summary)
            if [ -f "$logfile" ]; then
                echo -e "${BLUE}=== Log Summary: $target ===${NC}"
                echo ""

                # Connection stats
                local connects=$(grep -c "Player connected" "$logfile" 2>/dev/null || echo 0)
                local disconnects=$(grep -c "Player disconnected" "$logfile" 2>/dev/null || echo 0)
                echo -e "Connections:    ${GREEN}$connects${NC} connects, ${YELLOW}$disconnects${NC} disconnects"

                # Zone stats
                local zones=$(grep -c "Zone.*created" "$logfile" 2>/dev/null || echo 0)
                echo -e "Zones created:  ${GREEN}$zones${NC}"

                # Error count
                local errors=$(grep -ciE "(error|fail|exception)" "$logfile" 2>/dev/null || echo 0)
                if [ "$errors" -gt 0 ]; then
                    echo -e "Errors:         ${RED}$errors${NC}"
                else
                    echo -e "Errors:         ${GREEN}0${NC}"
                fi

                # Last activity
                echo ""
                echo -e "${BLUE}Last 5 lines:${NC}"
                tail -n 5 "$logfile"
            else
                warn "No log file found: $logfile"
            fi
            ;;
        tail)
            if [ -f "$logfile" ]; then
                info "Tailing $target log (Ctrl+C to stop)..."
                tail -f "$logfile"
            else
                warn "No log file found: $logfile"
            fi
            ;;
        clean)
            info "Cleaning logs..."
            rm -f "$LOG_DIR"/*.log "$LOG_DIR"/*.pid
            ok "Logs cleaned"
            ;;
    esac
}

cmd_status() {
    cd_root
    ensure_log_dir

    echo -e "${BLUE}=== MMO Game Status ===${NC}"
    echo ""

    # Process status
    echo -e "${BLUE}Processes:${NC}"
    if pgrep -f "$SERVER_PROJECT" > /dev/null 2>&1; then
        echo -e "  Server: ${GREEN}RUNNING${NC} ($(pgrep -f "$SERVER_PROJECT" | head -1))"
    else
        echo -e "  Server: ${YELLOW}STOPPED${NC}"
    fi

    if pgrep -f "$CLIENT_PROJECT" > /dev/null 2>&1; then
        echo -e "  Client: ${GREEN}RUNNING${NC} ($(pgrep -f "$CLIENT_PROJECT" | head -1))"
    else
        echo -e "  Client: ${YELLOW}STOPPED${NC}"
    fi

    # Port status
    echo ""
    echo -e "${BLUE}Ports:${NC}"
    if fuser "$GAME_PORT/udp" 2>/dev/null; then
        echo -e "  UDP $GAME_PORT: ${GREEN}IN USE${NC}"
    else
        echo -e "  UDP $GAME_PORT: ${YELLOW}FREE${NC}"
    fi

    if fuser "$HTTP_PORT/tcp" 2>/dev/null; then
        echo -e "  TCP $HTTP_PORT: ${GREEN}IN USE${NC}"
    else
        echo -e "  TCP $HTTP_PORT: ${YELLOW}FREE${NC}"
    fi

    # Config
    echo ""
    echo -e "${BLUE}Config:${NC}"
    if [ -f "$NETWORK_CONFIG" ]; then
        echo "  Transport: $(grep -o '"transport"[^,]*' "$NETWORK_CONFIG" | cut -d'"' -f4)"
        echo "  Server:    $(grep -o '"serverHost"[^,]*' "$NETWORK_CONFIG" | cut -d'"' -f4):$(grep -o '"serverPort"[^,]*' "$NETWORK_CONFIG" | grep -o '[0-9]*')"
    fi
}

cmd_clean() {
    cd_root

    info "Cleaning build artifacts..."
    dotnet clean -v q 2>/dev/null || true
    rm -rf bin obj dist
    find . -type d -name "bin" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "obj" -exec rm -rf {} + 2>/dev/null || true

    info "Cleaning logs..."
    rm -rf "$LOG_DIR"

    ok "Clean complete"
}

# ============================================================================
# MAIN
# ============================================================================
main() {
    local cmd="${1:-help}"
    shift || true

    case $cmd in
        help|--help|-h) cmd_help ;;
        server|s)       cmd_server "$@" ;;
        client|c)       cmd_client "$@" ;;
        stop)           cmd_stop "$@" ;;
        restart|r)      cmd_restart "$@" ;;
        build|b)        cmd_build "$@" ;;
        logs|l)         cmd_logs "$@" ;;
        status|st)      cmd_status ;;
        clean)          cmd_clean ;;
        *)
            err "Unknown command: $cmd"
            echo "Run './CLI/game help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
